// Copyright 2000-2024 JetBrains s.r.o. and contributors. Use of this source code is governed by the Apache 2.0 license.
package org.jetbrains.intellij.build.bazel

import java.nio.file.Files
import java.nio.file.Path

class BazelFileUpdater(private val file: Path) {
  private var originalContent: String? = runCatching { Files.readString(file) }.getOrNull()
  private var fileContent: String? = originalContent

  fun insertAutoGeneratedSection(sectionName: String, autoGeneratedContent: String) {
    require(sectionName.isNotEmpty()) {
      "sectionName must not be empty"
    }
    require(autoGeneratedContent.isNotEmpty()) {
      "autoGeneratedContent must not be empty"
    }

    val startToken = "### auto-generated section `$sectionName` start"
    val endToken = "### auto-generated section `$sectionName` end"

    val newSection = "\n$autoGeneratedContent"
    val fileContent = fileContent
    if (fileContent == null) {
      resetFileContent(startToken, newSection, endToken)
      return
    }

    val startIndex = fileContent.indexOf(startToken)
    val endIndex = fileContent.indexOf(endToken)
    if (startIndex == -1 || endIndex == -1) {
      if (false) {
        resetFileContent(startToken, newSection, endToken)
      }
      else {
        println("Section `$sectionName` doesn't exist in the file $file")
      }
    }
    else {
      this.fileContent = fileContent.substring(0, startIndex + startToken.length) + newSection + fileContent.substring(endIndex)
    }
  }

  private fun resetFileContent(startToken: String, newSection: String, endToken: String) {
    this.fileContent = startToken + "\n" + newSection.trim() + "\n" + endToken
  }

  fun save() {
    if (originalContent != fileContent) {
      Files.writeString(file, fileContent)
    }
  }
}